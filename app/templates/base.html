<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    {% import "bootstrap/wtf.html" as wtf %}
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>基站</title>
<link href="/static/css/bootstrap.min.css" rel="stylesheet" />
<script src="/static/js/jquery-3.2.1.min.js" type="text/javascript"></script>
<script src="/static/js/bootstrap.min.js" type="text/javascript"></script>
<style type="text/css">
	.content{
		margin:2% 8%;
		overflow:hidden;
	}
	.right-float{
		float:right;
	}
	.nav-text{
		font-size:1.1em;
	}
	.nav-a{
		padding:15px 8px !important;
	}
	.container{
		margin:0 8%;
		padding:0 0;
	}
	.config-right{
		float:right;
		width:24%;
	}
	.config-right-hide{
		display:none;
	}
	.pop-show-left{
		float:left;
		width:75%;
	}
	.td-width{
		width:23%;
	}
	.td-width2{
		width:45%;
		padding:8px 8px 8px 20px;
		border-bottom:1px solid #ccc;
	}
    .td-width3{
		width:50%;
		padding:8px 8px 8px 20px;
		border-bottom:1px solid #ccc;
	}
	.td-padding{
		padding:0 4%;
	}
	.td-border{
		border-left:1px solid #ccc;
	}
	.table-width{
		width:100%;
	}
	.config-btn{
		border:0;
		padding:0;
	}
    .form_trx{
        position: absolute;
        right: 15px;
    }
</style>
</head>
<body>
<nav class="navbar navbar-default ">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand nav-text" href="#">Brand</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
		  <li class="nav-text"><a class="nav-a" href="{{url_for('main.page_index')}}">首页</a></li>
		  <li class="nav-text"><a class="nav-a" href="{{url_for('main.page_base',bsid=bsid)}}">>&nbsp;&nbsp;&nbsp;&nbsp;基站 {{bsid}}</a></li>
      </ul>
	  <ul class="nav navbar-nav right-float">
		  {% if current_user.is_authenticated %}
		  <li class=""><a href="{{url_for("auth.logout")}}">退出登录</a></li>
		{%else %}
        <li class=""><a href="#">登录</a></li>
		{%endif%}
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

    <div >
	    {% for message in get_flashed_messages() %}
	        <div class="alert alert-warning" id="flash_alert_bs">
	    	    {{message}}
	        </div>
        {% endfor %}
    </div>
    <div class="content">
	    <div class="config-right-hide" id="right">
            <form class="form-horizontal" method="post" action="/bs/{{bsid}}/push_bscfg" onsubmit="return validate_bscfg()" >
			  <fieldset>
                  <legend>配置基站</legend>
			  <div class="form-group">
				<label for="f-bsname" class="col-sm-5 control-label">基站编号</label>
				<div class="col-sm-6">
					<input type="text" class="form-control" id="f-bsname" name="bs_name"/>
				</div>
			  </div>
			  <div class="form-group">
				<label for="f-ip1" class="col-sm-5 control-label">基站IP1</label>
				<div  class="col-sm-6">
				  <input type="text" class="form-control" id="f-ip1" name="BSIP1"/>
				</div>
			  </div>
                  	  <div class="form-group">
				<label for="f-port1" class="col-sm-5 control-label">端口号1</label>
				<div id="d1" class="col-sm-6">
				  <input type="text" class="form-control" id="f-port1"  name="BSPort1" /><span id="s3" ></span>
				</div>
			  </div>
                  <div class="form-group">
				<label for="f-ip2" class="col-sm-5 control-label">基站IP2</label>
				<div  class="col-sm-6">
				  <input type="text" class="form-control" id="f-ip2" name="BSIP2"/>
				</div>
			  </div>
			  <div class="form-group">
				<label for="f-port2" class="col-sm-5 control-label">端口号2</label>
				<div id="d1" class="col-sm-6">
				  <input type="text" class="form-control" id="f-port2"  name="BSPort2"/><span id="s5" ></span>
				</div>
			  </div>
			  <div class="form-group">
				<label for="f-ulPacketTime" class="col-sm-5 control-label">上行子帧时间</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-ulPacketTime" name="ulPacketTime"/><span id="s6"></span>
				</div>
			  </div>
			  <div class="form-group">
				<label for="f-ulPacketNum" class="col-sm-5 control-label">上行子帧数目</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-ulPacketNum" name="ulPacketNum" /><span></span>
				</div>
			  </div>
			  <div class="form-group">
				<label for="f-ulCompetitionSectionTime" class="col-sm-5 control-label">上行竞争时间</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-ulCompetitionSectionTime"  name="ulCompetitionSectionTime"/>
				</div>
			  </div>
              <div class="form-group">
				<label for="f-dlPacketTime" class="col-sm-5 control-label">下行子帧时间</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-dlPacketTime"  name="dlPacketTime" />
				</div>
			  </div>

              <div class="form-group">
				<label for="f-dlLogicSubFrameNum" class="col-sm-5 control-label">下行子帧数目</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-dlLogicSubFrameNum"  autocomplete="off" name="dlLogicSubFrameNum" />
				</div>
			  </div>
              <div class="form-group">
				<label for="f-dlLogicSubFrameIdx" class="col-sm-5 control-label">下行子帧序号</label>
				<div class="col-sm-6">
				  <input type="text" class="form-control" id="f-dlLogicSubFrameIdx"  autocomplete="off" name="dlLogicSubFrameIdx"/>
				</div>
			  </div>

			  <div class="form-group">
				<div class="col-sm-offset-4 col-sm-4">
				  <button type="button" class="btn btn-default form-control" onclick="pullbscfg()">获取</button>
				</div>
				<div class="col-sm-4 right-float">
				  <button type="submit" class="btn btn-default form-control" >修改</button>
				</div>
			  </div>
			  </fieldset>
		  </form>
        </div>
        <div id="left">
			<div class="panel panel-default">
				<!-- Default panel contents -->
				 <div class="panel-heading">当前通信状态
					 {% if current_user.is_admin() %}
					<button class="config-btn right-float" onclick="popConfig()">配置基站
						<span class="glyphicon glyphicon-hand-right"></span>
					</button>
					{%endif%}
				 </div>
				 <div class="panel-body">
					<table class="table-width">
						<tr>
							<td class="td-width">基站ID</td>
							<td id="bsid" class="td-width">--</td>
							<td class="td-width td-padding  td-border">总吞吐量</td>
							<td id="throughout" class="td-padding">--</td>
						</tr>
						<tr>
							<td class="td-width">基站编号</td>
							<td id="bs_name" class="td-width"></td>
							<td class="td-padding td-border">上行吞吐量</td>
							<td id="=ulthroughout" class="td-padding ">--</td>
						</tr>
						<tr>
							<td >基站IP</td>
							<td id = "bsip">--</td>
							<td class="td-padding td-border">下行吞吐量</td>
							<td id="dlthroughout" class="td-padding"></td>
						</tr>
						<tr>
							<td >端口</td>
							<td id="port" ></td>
							<td class="td-padding td-border">丢包率</td>
							<td id="packetmiss" class="td-padding"></td>
						</tr>
					</table>
				 </div>
			</div>
			<div class="panel panel-default map">
				<a href="{{url_for('main.map',bsid=bsid)}}">点击查看终端位置</a>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">
					<h2 class="panel-title">通道</h2>
				</div>
				<div class="panel-body">
					<br />请从下面列表中选择您将访问的通道。(若您想重新选择访问基站，请返回上一级。)<br /><br />
					<button type="button" onclick="(function(){
								 url_t = '/bs/{{ bsid }}/addtrx';
								 window.open(url_t,'_self');
								 })();">添加通道</button>

				</div>
				<table class="table">
					<tr>
						<th class="td-width2">通道ID</th>
						<th class="td-width2">通道Name</th>
						<th class="td-width2">终端数量</th>
					</tr>
				</table>
            </div>
        </div>
    </div>
</body>



<script type="text/javascript">
{#    弹出右侧窗口#}
    function popConfig(){
        var config_view = document.getElementById("right");
        var show_view = document.getElementById("left");
        if(config_view.className == "config-right-hide"){
            config_view.className = "config-right";
            show_view.className = "pop-show-left";
            //getConfig();
        }else{
            config_view.className = "config-right-hide";
            show_view.className = "";
        }
    }
{#    获取配置信息#}
    function pullbscfg()
    {
        var xmlhttp;
        if(window.XMLHttpRequest){
            xmlhttp = new XMLHttpRequest();
        }else{
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
            xmlhttp.onreadystatechange = function()
            {
                if(xmlhttp.readyState == 4 && xmlhttp.status == 200)
                {
                    var txt = xmlhttp.responseText;
                    var obj = eval("("+txt+")");
                    var form = document.getElementsByTagName("form")[0];
                    var inputs = [];
                    inputs = form.getElementsByTagName("input");
                    inputs[0].value =obj.bs_name;//BSName
                    inputs[1].value =obj.BSIP1;//BSIP1
                    inputs[2].value =obj.BSPort1;//BSPort1
                    inputs[3].value =obj.BSIP2;//BSIP2
                    inputs[4].value =obj.BSPort2;//
                    inputs[5].value =obj.ulPacketTime;//
                    inputs[6].value =obj.ulPacketNum;//
                    inputs[7].value =obj.ulCompetitionSectionTime;//
                    inputs[8].value =obj.dlPacketTime;//
                    inputs[9].value =obj.dlLogicSubFrameNum;//
                    inputs[10].value =obj.dlLogicSubFrameIdx;//

                    var bs_table01 = document.getElementsByTagName("table")[0];
                    var tds01 = bs_table01.getElementsByTagName("td");
                    tds01[5].innerHTML = obj.bs_name;
                    tds01[9].innerHTML = obj.BSIP1;
                    tds01[13].innerHTML = obj.BSPort1;

                    if(obj.errors=="none"){alert("get success!");}
                    else{alert(obj.errors);}

                }
            }
        var url = "/bs/{{ bsid }}/pull_bscfg";
        xmlhttp.open("GET",url,true);
        xmlhttp.send();
    }
    function validate_bscfg() {
{#前端验证： 是否为空， #}

{#        验证基站编号是否重复#}
        var flag=0;
        $.ajaxSettings.async = false;
        $.post("/bs/{{ bsid }}/push_bscfg_datacheck",
            {
                bs_name:$("#f-bsname").val()
            },function (data, status) {
                if(status=="success")
                {
                    var text=eval("("+data+")");
                    if(text.bs_name!=0)
                    {
                        alert("编号一存在！");
                        flag=-1;
                    }
                }
                else
                {
                    flag=-1;
                }
            });
        $.ajaxSettings.async=true;
	    if(flag==0)
        {
            return true;
        }
        else {
{#	        alert("f");#}
	        return false;
	    }
    }
</script>

<script type="text/template" id="html_template">
<div class="text-right right-float">
    <button type="button" class="btn btn-default" onclick="">
        <span class="glyphicon glyphicon glyphicon-zoom-in"></span>
    </button>
</div>
</script>

<script type="text/javascript">
    $(document).ready(function () {


        url_t = "/bs/{{ bsid }}/base_data";
        $.get(url_t,function (txt) {
            var obj = eval("(" + txt + ")");
            var tr_num = obj.length;
            //数据处理
            var bs_table0 = document.getElementsByTagName("table")[0];
            var tds0 = bs_table0.getElementsByTagName("td");
            tds0[3].innerHTML = obj[tr_num - 1].Throughout;
            tds0[5].innerHTML = obj[tr_num - 1].bs_name;
            tds0[7].innerHTML = obj[tr_num - 1].ulThroughout;
            tds0[15].innerHTML = obj[tr_num - 1].PacketMiss;
            tds0[11].innerHTML = obj[tr_num - 1].dlThroughout;
            tds0[9].innerHTML = obj[tr_num - 1].BSIP1;
            tds0[13].innerHTML = obj[tr_num - 1].BSPort1;
            tds0[1].innerHTML = obj[tr_num - 1].BSID;
            var bs_table1 = document.getElementsByTagName("table")[1];
            for (var i = 0; i < tr_num - 1; i++) {
                var tr = document.createElement("tr");
                bs_table1.appendChild(tr);
                var td = [];
                for (var j = 0; !(j >= 3); j++) {
                    td[j] = document.createElement("td");
                    td[j].className = "td-width2";
                    tr.appendChild(td[j]);
                }
                td[3] = document.createElement("td");
                td[3].className = "td-width3";
                tr.appendChild(td[3]);

                td[0].innerHTML = obj[i].trxid;
                td[1].innerHTML = obj[i].trx_name;
                td[2].innerHTML = obj[i].ssnum;
                td[3].innerHTML = document.getElementById('html_template').innerHTML;
                td[3].getElementsByTagName("button")[0].onclick = function (num) {
                    return function () {
                        url = "/bs/{{ bsid }}/" + obj[num].trxid;
                        window.location = url;
                    }
                }(i);
            }
        });
        setTimeout(fucfade,2000);

    });
        function fucfade(){
        $("#flash_alert_bs").hide(1000);
    }
</script>
</body>
</html>
